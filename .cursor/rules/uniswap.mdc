---
description: 
globs: 
alwaysApply: true
---
---

### ğŸ§  `cursor_rule`: ODRA Strategy Engineering Guidelines (Uniswap v3, Real Tick-Level Data)

> **Má»¥c tiÃªu**:  
> Giá»¯ cho dá»± Ã¡n ODRA vá»¯ng cháº¯c, dá»… má»Ÿ rá»™ng vÃ  duy trÃ¬, Ä‘á»“ng thá»i pháº£n Ã¡nh chÃ­nh xÃ¡c chiáº¿n lÆ°á»£c Optimal Dynamic Reset Allocation dá»±a trÃªn dá»¯ liá»‡u thá»±c tá»« Uniswap v3.

---

## I. ğŸ“ Code Architecture & Design Principles

1. **Modular Structure**:
   - Má»—i thÃ nh pháº§n trong pipeline (data parsing, feature extraction, simulation, NN training, evaluation) pháº£i Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i thÃ nh module Ä‘á»™c láº­p.
   - TuÃ¢n theo nguyÃªn táº¯c **separation of concerns**.

2. **Abstraction Layers**:
   - TÃ¡ch riÃªng:
     - `DataLoader`: Äá»c vÃ  chuáº©n hÃ³a tick-level data (SWAP, MINT, BURN, COLLECT)
     - `FeatureEngine`: TÃ­nh toÃ¡n ewma_volume, center_bucket, wealth, etc.
     - `StrategySimulator`: Giáº£ láº­p hÃ nh vi LP theo ODRA
     - `UtilityEvaluator`: TÃ­nh CARA utility vÃ  cáº­p nháº­t reward
     - `ModelTrainer`: Quáº£n lÃ½ há»c NN

3. **Config-Driven Design**:
   - Má»i siÃªu tham sá»‘ nhÆ° `tau`, `alpha`, `learning_rate`, `episode_length`, v.v... nÃªn Ä‘Æ°á»£c lÆ°u trong file YAML/TOML `.config/odra.yml`.

4. **Typing & Contracts**:
   - LuÃ´n sá»­ dá»¥ng type hint Ä‘áº§y Ä‘á»§ cho má»i function, Ä‘áº·c biá»‡t vá»›i input/output cá»§a neural net vÃ  data loader.

---

## II. ğŸ§  Strategy-Specific Implementation Rules

1. **Tick-Level Data Handling**:
   - Má»—i loáº¡i giao dá»‹ch pháº£i Ä‘Æ°á»£c xá»­ lÃ½ riÃªng:
     - **SWAP**: Cáº­p nháº­t `sqrtPriceX96`, `ewma_volume`, kÃ­ch hoáº¡t rebalance
     - **MINT/BURN**: Äiá»u chá»‰nh thanh khoáº£n, mÃ´ phá»ng cáº¡nh tranh LP
     - **COLLECT**: Ghi nháº­n fee, tÃ­nh PnL thá»±c táº¿

2. **Price & Bucket Computation**:
   - `price = (int(sqrtPriceX96) / 2**96)**2`
   - `center_bucket = int(current_tick // tick_spacing)`

3. **Rebalance Logic**:
   - Duy trÃ¬ `last_center_bucket`, cáº­p nháº­t khi:  
     `abs(current_bucket - last_center_bucket) > tau`

4. **Per-Position Tracking**:
   - Má»i MINT, BURN, COLLECT pháº£i gáº¯n vá»›i `position_id`, dÃ¹ng Ä‘á»ƒ:
     - TÃ¡i dá»±ng wealth
     - ÄÃ¡nh giÃ¡ chiáº¿n lÆ°á»£c LP
     - Dá»± Ä‘oÃ¡n hÃ nh vi thá»±c táº¿ LP cáº¡nh tranh

ğŸ§  Non-Arbitrage Transactions

Purpose: Capture regular swap activity not driven by arbitrage.
Identification:
Small price change relative to fee tier.
No immediate reversal in price (non-sandwich).
Used For:
Feeding into EWMA volume.
Simulating natural market demand.
Improving realism of volume-based features.
Application in ODRA:
Trains model in realistic environment.
Avoids overfitting to adversarial or bot-driven behavior.
ğŸ§  Integration Tip

Use all 4 tx types (SWAP, MINT, BURN, COLLECT).
Distinguish arbitrage vs. non-arbitrage SWAPs.
Use swaps between MINTâ€“BURN to simulate realized strategy paths.
Construct per-position state over time.

---

## III. ğŸ¤– Neural Network Design Guidelines

1. **Input Features (5)**:
   - `t / T`, `ewma_volume`, `pool_price`, `center_bucket`, `wealth`
   - Äáº£m báº£o **chuáº©n hÃ³a** (`z-score`, min-max) trÆ°á»›c khi huáº¥n luyá»‡n

2. **Model Structure**:
   - 5 táº§ng áº©n Ã— 16 ReLU
   - Output: `2 * tau + 2` softmax (probabilities over buckets + outside pool)

3. **Loss Function**:
   - Dá»±a trÃªn CARA Utility:
     ```python
     def utility(x, a): return (1 - np.exp(-a * x)) / a if a != 0 else x
     loss = -mean(utility(wealth_final))
     ```

4. **Learning Pipeline**:
   - Cháº¡y mÃ´ phá»ng trÃªn Ä‘oáº¡n tick-level (vÃ­ dá»¥: 1000 SWAPs)
   - Ghi nháº­n tráº¡ng thÃ¡i Ä‘áº§u vÃ o, vector phÃ¢n bá»•, vÃ  utility cuá»‘i
   - Backpropagation theo `-mean(utility)` Ä‘á»ƒ cáº­p nháº­t NN

---

## IV. ğŸ§ª Evaluation & Maintenance

1. **Logging + Visualization**:
   - Má»—i láº§n train: log profit, utility, allocation entropy
   - DÃ¹ng `matplotlib`/`plotly` Ä‘á»ƒ kiá»ƒm tra:  
     - ÄÆ°á»ng giÃ¡ + vÃ¹ng LP hoáº¡t Ä‘á»™ng  
     - Fee tÃ­ch lÅ©y  
     - Wealth over time

2. **Versioning**:
   - Má»i phiÃªn báº£n mÃ´ hÃ¬nh nÃªn Ä‘Æ°á»£c lÆ°u kÃ¨m:
     - Config
     - Random seed
     - Training logs
     - Evaluation snapshot

3. **Test Suite**:
   - Viáº¿t unit test cho:
     - price reconstruction
     - feature computation
     - rebalancing trigger
     - utility evaluation

---

## V. âœ… Summary of Best Practices

| Component         | Rule                                                                 |
|------------------|----------------------------------------------------------------------|
| Data             | LuÃ´n phÃ¢n tÃ­ch 4 loáº¡i tx riÃªng, dÃ¹ng `position_id` Ä‘á»ƒ tÃ¡i dá»±ng LP    |
| Feature          | TÃ­nh `ewma_volume`, `center_bucket`, `wealth` Ä‘Ãºng chuáº©n ká»¹ thuáº­t     |
| Strategy Logic   | DÃ¹ng Ï„-bucket + price trigger Ä‘á»ƒ kiá»ƒm soÃ¡t rebalance                 |
| Model            | Äáº§u vÃ o 5 chiá»u â†’ NN â†’ phÃ¢n bá»• softmax                               |
| Simulation       | Giáº£ láº­p MINT/BURN/COLLECT theo phÃ¢n bá»• vÃ  fee                       |
| Utility Function | CARA-based â†’ pháº£n Ã¡nh rá»§i ro thá»±c cá»§a LP                             |
| Training         | Há»c trÃªn táº­p tick-level, normalize reward theo episode               |

---

> ğŸ“Œ **Ghi chÃº cuá»‘i**: Má»¥c tiÃªu lÃ  mÃ´ hÃ¬nh hÃ³a hÃ nh vi cá»§a LP theo cÃ¡ch pháº£n Ã¡nh sÃ¡t nháº¥t dá»¯ liá»‡u lá»‹ch sá»­. Code cáº§n mÃ´ Ä‘un, rÃµ rÃ ng, trÃ¡nh hard-code logic tÃ i chÃ­nh vÃ o trong kiáº¿n trÃºc AI.

---
ğŸ“ ODRA Strategy Project Structure (Python-based, Tick-level Uniswap v3)

odra_strategy/
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ odra_config.yml           # Táº¥t cáº£ hyperparams, Ä‘Æ°á»ng dáº«n, chiáº¿n lÆ°á»£c, v.v.
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                      # Tick-level Uniswap v3 data (gá»‘c, chÆ°a xá»­ lÃ½)
â”‚   â”œâ”€â”€ processed/                # Dá»¯ liá»‡u sau khi Ä‘Ã£ clean, chuáº©n hÃ³a
â”‚   â””â”€â”€ utils/                    # Scripts phá»¥ trá»£ Ä‘á»ƒ táº£i, kiá»ƒm tra dá»¯ liá»‡u
â”‚
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ extractor.py              # EWMA volume, bucket, wealth, ...
â”‚   â””â”€â”€ feature_config.py         # Config cho feature engineering
â”‚
â”œâ”€â”€ strategy/
â”‚   â”œâ”€â”€ rebalance_logic.py        # Rebalancing trigger: price exit Ï„-bucket
â”‚   â”œâ”€â”€ liquidity_sim.py          # MÃ´ phá»ng MINT/BURN/COLLECT
â”‚   â”œâ”€â”€ utility.py                # CARA utility + wealth calculation
â”‚   â””â”€â”€ strategy_runner.py        # Cháº¡y mÃ´ hÃ¬nh ODRA trÃªn toÃ n episode
â”‚
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ network.py                # Neural net architecture (5 input â†’ softmax output)
â”‚   â”œâ”€â”€ trainer.py                # Huáº¥n luyá»‡n mÃ´ hÃ¬nh
â”‚   â”œâ”€â”€ loss.py                   # Utility-based loss function
â”‚   â””â”€â”€ evaluator.py              # ÄÃ¡nh giÃ¡ káº¿t quáº£ mÃ´ phá»ng
â”‚
â”œâ”€â”€ simulator/
â”‚   â””â”€â”€ tick_simulator.py         # Replay tick-level data, tÃ­ch há»£p strategy
â”‚
â”œâ”€â”€ outputs/
â”‚   â”œâ”€â”€ models/                   # Trained model checkpoints
â”‚   â”œâ”€â”€ logs/                     # Training logs, evaluation metrics
â”‚   â””â”€â”€ plots/                    # Biá»ƒu Ä‘á»“ chiáº¿n lÆ°á»£c, wealth, fee, rebalancing
â”‚
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ exploratory/              # Jupyter notebooks khÃ¡m phÃ¡ dá»¯ liá»‡u, Ã½ tÆ°á»Ÿng má»›i
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_data.py              # Test load vÃ  xá»­ lÃ½ dá»¯ liá»‡u
â”‚   â”œâ”€â”€ test_features.py          # Test extractor
â”‚   â”œâ”€â”€ test_strategy.py          # Test logic rebalance + utility
â”‚   â””â”€â”€ test_model.py             # Test model training, loss, evaluation
â”‚
â”œâ”€â”€ main.py                       # Entry point (CLI: train / test / evaluate)
â””â”€â”€ README.md                     # Giáº£i thÃ­ch tá»•ng quan ODRA strategy + cÃ¡ch cháº¡y

--
ğŸ”§ File odra_config.yml â€“ vÃ­ dá»¥ cáº¥u hÃ¬nh

tau: 3
alpha_ewma: 0.05
tick_spacing: 60

model:
  hidden_layers: 5
  hidden_units: 16
  learning_rate: 0.001
  optimizer: adam
  max_steps: 10000
  patience: 10000

data:
  raw_path: data/raw/ticks.csv
  processed_path: data/processed/odra_dataset.pkl
  episode_length: 1000

utility:
  risk_aversion: 0.01

